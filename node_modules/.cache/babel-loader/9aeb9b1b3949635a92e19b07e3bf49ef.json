{"remainingRequest":"/Users/xuyangbing/Desktop/devopsManage/client/node_modules/thread-loader/dist/cjs.js!/Users/xuyangbing/Desktop/devopsManage/client/node_modules/babel-loader/lib/index.js!/Users/xuyangbing/Desktop/devopsManage/client/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/xuyangbing/Desktop/devopsManage/client/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/xuyangbing/Desktop/devopsManage/client/src/views/Xterm.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/xuyangbing/Desktop/devopsManage/client/src/views/Xterm.vue","mtime":1553223778000},{"path":"/Users/xuyangbing/Desktop/devopsManage/client/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/xuyangbing/Desktop/devopsManage/client/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/xuyangbing/Desktop/devopsManage/client/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/xuyangbing/Desktop/devopsManage/client/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/xuyangbing/Desktop/devopsManage/client/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.array.iterator\";\nimport \"core-js/modules/es6.promise\";\nimport \"core-js/modules/es7.promise.finally\";\n//\n//\n//\n//\n//\n//\nimport { Terminal } from 'xterm';\nimport 'xterm/dist/xterm.css';\nimport * as fit from 'xterm/lib/addons/fit/fit';\nimport * as attach from 'xterm/lib/addons/attach/attach'; //import SockJS from '../../public/js/sockjs.min.js'\n\nTerminal.applyAddon(fit);\nTerminal.applyAddon(attach);\nexport default {\n  name: 'pod',\n  data: function data() {\n    return {\n      term: null,\n      websock: null,\n      timer: null\n    };\n  },\n  computed: {\n    terminalId: function terminalId() {\n      return \"terminal_\".concat(this._uid);\n    },\n    cluster: function cluster() {\n      return this.$route.params.cluster;\n    },\n    namespace: function namespace() {\n      return localStorage.getItem('namespace');\n    },\n    pod: function pod() {\n      return localStorage.getItem('pod');\n    },\n    container: function container() {\n      return this.$route.params.container;\n    },\n    wsUrl: function wsUrl() {\n      var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';\n      var host = window.location.host;\n      return \"\".concat(host); //return `${protocol}${host}`\n    }\n  },\n  mounted: function mounted() {\n    var _self = this;\n\n    this.term = new Terminal();\n    this.term.open(document.getElementById(this.terminalId));\n    this.initWebSocket();\n    this.term.on('data', function (data) {\n      // 写给服务端, 由服务端发给container\n      var msg = {\n        type: \"input\",\n        input: data\n      };\n\n      _self.websocketsend(JSON.stringify(msg));\n    }), window.addEventListener(\"resize\", function () {\n      this.term.fit(); // 把web终端的尺寸term.rows和term.cols发给服务端, 通知sshd调整输出宽度\n\n      var msg = {\n        type: \"resize\",\n        rows: this.term.rows,\n        cols: this.term.cols\n      };\n\n      _self.websocketsend(JSON.stringify(msg)); // console.log(term.rows + \",\" + term.cols)\n\n    });\n  },\n  beforeDestroy: function beforeDestroy() {\n    if (this.term) {\n      this.term.destroy();\n    }\n\n    window.removeEventListener('resize', this.handleResize); // 移除获取高度事件\n  },\n  methods: {\n    initWebSocket: function initWebSocket() {\n      // 初始化weosocket\n      //const wsurl = `${location.origin}/api/terminal/ws`\n      //const url = `${this.wsUrl}?namespace=${this.namespace}&pod=${this.pod}`\n      var url = \"ws://\".concat(this.wsUrl, \"/api/v1/namespaces/\").concat(this.namespace, \"/pods/\").concat(this.pod, \"/exec?command=sh&stderr=true&stdin=true&stdout=true&tty=true\"); // https://172.18.11.25:6443/api/v1/namespaces/default/pods/nginx-deployment-5cbd8757f-d5qvx/exec?command=sh&container=nginx&stderr=true&stdin=true&stdout=true&tty=true\n      //const url = `ws://${this.wsUrl}/api/terminal/ws?podNs=${this.namespace}&podName=${this.pod}` \n      //this.websock = new WebSocket(wsurl)\n\n      this.websock = new WebSocket(url);\n      this.websock.onmessage = this.websocketonmessage;\n      this.websock.onopen = this.websocketonopen;\n      this.websock.onerror = this.websocketonerror;\n      this.websock.onclose = this.websocketclose;\n    },\n    websocketonopen: function websocketonopen() {// 连接建立之后执行send方法发送数据\n    },\n    websocketonerror: function websocketonerror() {\n      // 连接建立失败重连\n      this.term.write('连接出错\\r\\n'); // this.initWebSocket()\n    },\n    websocketonmessage: function websocketonmessage(e) {\n      // 数据接收\n      var redata = JSON.parse(e.data);\n      this.term.write(redata.output);\n    },\n    websocketsend: function websocketsend(Data) {\n      // 数据发送\n      if (this.websock.readyState === 1) {\n        this.websock.send(Data);\n      }\n    },\n    websocketclose: function websocketclose(e) {\n      // 关闭\n      console.log('断开连接', e);\n      this.socket.close();\n    },\n    handleResize: function handleResize() {\n      var _this = this;\n\n      if (this.timer) {\n        clearTimeout(this.timer);\n        this.timer = null;\n      }\n\n      this.timer = setTimeout(function () {\n        _this.setTermSize();\n      }, 2000);\n    },\n    get_term_size: function get_term_size() {\n      var initWidth = 9;\n      var initHeight = 17;\n      var windowsWidth = document.body.clientWidth;\n      var windowsHeight = document.documentElement.clientHeight;\n      return {\n        cols: Math.floor(windowsWidth / initWidth),\n        rows: Math.floor(windowsHeight / initHeight)\n      };\n    },\n    setTermSize: function setTermSize() {\n      var _this$get_term_size = this.get_term_size(),\n          cols = _this$get_term_size.cols,\n          rows = _this$get_term_size.rows;\n\n      this.term.resize(cols, rows);\n      this.websock.send(JSON.stringify({\n        type: \"resize\",\n        rows: term.rows,\n        cols: term.cols\n      }));\n    }\n  }\n};",{"version":3,"sources":["Xterm.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div>\n    <div :id=\"terminalId\"/>\n  </div>\n</template>\n\n<script>\nimport { Terminal } from 'xterm'\nimport 'xterm/dist/xterm.css'\nimport * as fit from 'xterm/lib/addons/fit/fit'\nimport * as attach from 'xterm/lib/addons/attach/attach'\n//import SockJS from '../../public/js/sockjs.min.js'\nTerminal.applyAddon(fit)\nTerminal.applyAddon(attach)\n\n\nexport default {\n  name: 'pod',\n  data() {\n    return {\n      term: null,\n      websock: null,\n      timer: null\n    }\n  },\n  computed: {\n    terminalId() {\n      return `terminal_${this._uid}`\n    },\n    cluster() {\n      return this.$route.params.cluster\n    },\n    namespace() {\n      return localStorage.getItem('namespace')\n    },\n    pod() {\n      return localStorage.getItem('pod')\n    },\n    container() {\n      return this.$route.params.container\n    },\n    wsUrl() {\n      const protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://'\n      const host = window.location.host\n      return `${host}`\n      //return `${protocol}${host}`\n    },\n  },\n  mounted() {\n    const _self = this\n    this.term = new Terminal()\n    this.term.open(document.getElementById(this.terminalId))\n    this.initWebSocket()\n    this.term.on('data', function(data) {\n      // 写给服务端, 由服务端发给container\n      const msg = {type: \"input\", input: data}\n      _self.websocketsend(JSON.stringify(msg))\n    }),\n    window.addEventListener(\"resize\", function () {\n      this.term.fit()\n      // 把web终端的尺寸term.rows和term.cols发给服务端, 通知sshd调整输出宽度\n      const msg = {type: \"resize\", rows: this.term.rows, cols: this.term.cols}\n      _self.websocketsend(JSON.stringify(msg))\n      // console.log(term.rows + \",\" + term.cols)\n    })\n  },\n  beforeDestroy() {\n    if (this.term) {\n      this.term.destroy()\n    }\n    window.removeEventListener('resize', this.handleResize) // 移除获取高度事件\n  },\n  methods: {\n    initWebSocket() { // 初始化weosocket\n      //const wsurl = `${location.origin}/api/terminal/ws`\n      //const url = `${this.wsUrl}?namespace=${this.namespace}&pod=${this.pod}`\n      const url = `ws://${this.wsUrl}/api/v1/namespaces/${this.namespace}/pods/${this.pod}/exec?command=sh&stderr=true&stdin=true&stdout=true&tty=true`\n      // https://172.18.11.25:6443/api/v1/namespaces/default/pods/nginx-deployment-5cbd8757f-d5qvx/exec?command=sh&container=nginx&stderr=true&stdin=true&stdout=true&tty=true\n      //const url = `ws://${this.wsUrl}/api/terminal/ws?podNs=${this.namespace}&podName=${this.pod}` \n      //this.websock = new WebSocket(wsurl)\n      this.websock = new WebSocket(url)\n      this.websock.onmessage = this.websocketonmessage\n      this.websock.onopen = this.websocketonopen\n      this.websock.onerror = this.websocketonerror\n      this.websock.onclose = this.websocketclose\n    },\n    websocketonopen() { // 连接建立之后执行send方法发送数据\n    },\n    websocketonerror() { // 连接建立失败重连\n      this.term.write('连接出错\\r\\n')\n      // this.initWebSocket()\n    },\n    websocketonmessage(e) { // 数据接收\n      const redata = JSON.parse(e.data)\n      this.term.write(redata.output)\n    },\n    websocketsend(Data) { // 数据发送\n      if (this.websock.readyState === 1) {\n        this.websock.send(Data)\n      }\n    },\n    websocketclose(e) { // 关闭\n      console.log('断开连接', e)\n      this.socket.close()\n    },\n    handleResize() {\n      if (this.timer) {\n        clearTimeout(this.timer)\n        this.timer = null\n      }\n      this.timer = setTimeout(() => {\n        this.setTermSize()\n      }, 2000)\n    },\n    get_term_size() {\n      var initWidth = 9\n      var initHeight = 17\n\n      var windowsWidth = document.body.clientWidth\n      var windowsHeight = document.documentElement.clientHeight\n      return {\n        cols: Math.floor(windowsWidth / initWidth),\n        rows: Math.floor(windowsHeight / initHeight)\n      }\n    },\n    setTermSize() {\n      const { cols, rows } = this.get_term_size()\n      this.term.resize(cols, rows)\n      this.websock.send(JSON.stringify({type: \"resize\", rows: term.rows, cols: term.cols}))\n    },\n  }\n}\n</script>\n\n<style scoped>\n\n</style>\n"],"sourceRoot":"src/views"}]}